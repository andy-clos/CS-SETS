{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS SETS</title>
    <link rel="stylesheet" href="{% static 'css/navbar.css' %}">  
    <link rel="stylesheet" href="{% static 'css/header.css' %}">  
    <link rel="stylesheet" href="{% static 'css/style.css' %}">  
    <link rel="stylesheet" href="{% static 'css/footer.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

    <style>
    .section-title {
        font-size: 40px;
        font-weight: bold;
        margin-bottom: 10px;
    }
    #searchbar{
        width: 100%;
    }
    </style>
</head>
<body>
    <div class="container">

        {% include 'navbar.html' %} 

        {% include 'header.html' %} 

        <main>
            <section class="content">
                <h2 class="section-title">Users Management</h2>
                <div class="search-bar">
                    <input id="searchbar" type="text" onkeyup="searchUsers()" name="searchUsers" placeholder="Search users by email">
                  </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover w-100">
                                    <thead>
                                        <tr>
                                            <th>User Name</th>
                                            <th>User Email</th>
                                            <th>User Role</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="userTableBody">
                                        {% if users %}
                                            {% for user_key, user in users.items %}
                                            <tr class="user-row">
                                                <td>{{ user.name }}</td>
                                                <td>{{ user_key}}</td>
                                                <td>{{ user.role }}</td>
                                                <td>
                                                    <div class="btn-group" role="group">
                                                        <button class="btn btn-primary" style="margin-right: 10px;" onclick="populateUpdateForm('{{ user.name }}', '{{ user.role }}', '{{ user_key }}')">View</button>
                                                        <button class="btn btn-danger" onclick="confirmDelete('{{ user_key }}')">Delete</button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr><td colspan="3">No users found.</td></tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
            </section>
        </main>
                <!-- Update User Modal -->
                <div class="modal fade" id="updateUserModal" tabindex="-1" aria-labelledby="updateUserModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="updateUserModalLabel">User Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="updateUserForm">
                                    {% csrf_token %}
                                    <input type="hidden" name="user_email" id="user_email">
                                    <div class="mb-3">
                                        <label for="user_name" class="form-label">Name</label>
                                        <input type="text" class="form-control" id="user_name" name="user_name" required disabled>
                                    </div>
                                    <div class="mb-3">
                                        <label for="user_role" class="form-label">Email</label>
                                        <input type="text" class="form-control" id="user_email" name="user_email" required disabled>
                                    </div>
                                    <div class="mb-3">
                                        <label for="user_role" class="form-label">Role</label>
                                        <select class="form-control" id="user_role" name="user_role" required disabled>
                                            <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Admin</option>
                                            <option value="lecturer" {% if user.role == 'lecturer' %}selected{% endif %}>Lecturer</option>
                                            <option value="student" {% if user.role == 'student' %}selected{% endif %}>Student</option>
                                        </select>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

        {% include 'footer.html' %} 
    </div>
    <script src="{% static 'js/backend.js' %}"></script>
    <script>
    function searchUsers() {
        let input = document.getElementById("searchbar").value.toLowerCase();
        let userRows = document.querySelectorAll("#userTableBody .user-row");

        for (let i = 0; i < userRows.length; i++) {
            let nameCell = userRows[i].querySelector("td:nth-child(1)");
            let emailCell = userRows[i].querySelector("td:nth-child(2)");

            if ((nameCell && !nameCell.innerHTML.toLowerCase().includes(input)) &&
                (emailCell && !emailCell.innerHTML.toLowerCase().includes(input))) {
                userRows[i].style.display = "none";
            } else {
                userRows[i].style.display = "";
            }
        }
    }


    function populateUpdateForm(name, role, email) {
        document.getElementById('user_name').value = name;
        document.getElementById('user_role').value = role;
        document.getElementById('user_email').value = email.replace('-at-', '@').replace('-dot-', '.');
        // Show the modal
        var myModal = new bootstrap.Modal(document.getElementById('updateUserModal'));
        myModal.show();
    }

    
    function confirmDelete(userEmail) {
        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                // Perform the delete action via AJAX
                fetch(`/delete_user/${userEmail}/`, {  // Use encodedEmail here
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'  // Indicate that this is an AJAX request
                    }
                })
                .then(response => {
                    if (response.ok) {
                        // Show success message
                        Swal.fire(
                            'Deleted!',
                            'User has been deleted.',
                            'success'
                        ).then(() => {
                            // Redirect to the users management page
                            window.location.href = '/users-management/';
                        });
                    } else {
                        // Handle error response
                        Swal.fire(
                            'Error!',
                            'There was a problem deleting the user.',
                            'error'
                        );
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire(
                        'Error!',
                        'There was a problem deleting the user.',
                        'error'
                    );
                });
            }
        });
    }
    </script>
</body>
</html>
