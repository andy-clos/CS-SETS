{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS SETS</title>
    <link rel="stylesheet" href="{% static 'css/navbar.css' %}">  
    <link rel="stylesheet" href="{% static 'css/header.css' %}">  
    <link rel="stylesheet" href="{% static 'css/style.css' %}">  
    <link rel="stylesheet" href="{% static 'css/footer.css' %}">
    <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <style>
    .enrolled-students-section {
        margin-top: 2rem;
        margin-bottom: 2rem;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    .table th,
    .table td {
        padding: 0.75rem;
        border: 1px solid #dee2e6;
        text-align: left;
    }

    .table thead th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        text-align: center;
    }

    .table tbody tr:nth-of-type(odd) {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .table tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.075);
    }

    .text-center {
        text-align: center;
    }

    .search-bar {
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
    }

    .search-bar input {
        padding: 8px 15px;
        border-radius: 4px;
        border: 1px solid #ddd;
        width: 100%;
    }

    .search-bar input:focus {
        outline: none;
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }

    .sort-icon::after {
        content: '↕️';
        margin-left: 5px;
        opacity: 0.3;
    }

    th.asc .sort-icon::after {
        content: '↑';
        opacity: 1;
    }

    th.desc .sort-icon::after {
        content: '↓';
        opacity: 1;
    }

    th {
        user-select: none;
    }
    </style>
</head>
<body>
    <div class="container">

        {% include 'navbar.html' %} 

        {% include 'header.html' %} 

        <main>
          <section class="content">
            {% if error %}
            <p>{{ error }}</p>
            {% else %}
                {% for course in courses %}
                <h2 class="section-title">{{ course_code }} : {{course.course_name}}</h2>
                <form id="updateCourseForm" method="POST" action="{% url 'course-detail' semester_year=course.semester_year course_code=course_code %}" onsubmit="return handleUpdateSubmit(event)">
                    {% csrf_token %}
                    <label>Academic Year: </label>
                    <input id="academic_year" type="text" name="academic_year" placeholder="Enter academic year" maxlength="9" required value="{{ course.academic_year }}" readonly>
                    <br>
                    <label>Semester: </label>
                    {% if request.session.user_role == 'admin'%}
                    <select name="semester" id="semester" required readonly>
                        <option value="" disabled>Select semester</option>
                        <option value="1" {% if semester == "1" %}selected {% else %} disabled {% endif %}>1</option>
                        <option value="2" {% if semester == "2" %}selected {% else %} disabled {% endif %}>2</option>
                    </select>
                    {% else %}
                        <input id="semester" type="text" name="semester" placeholder="Enter semester" maxlength="1" required value="{{ semester }}" readonly>
                    {% endif %}
                    <br>
                    <label>Course Code: </label>
                    <input id="course_code" type="text" name="course_code" placeholder="Enter course code" required value="{{ course_code }}" readonly>
                    <br>
                    <label>Course Name: </label>
                    <input id="course_name" type="text" name="course_name" placeholder="Enter course name" required value="{{ course.course_name }}" {% if request.session.user_role == 'student' or request.session.user_role == 'lecturer' %} readonly {% endif %}>
                    <br>
                    <div id="lecturer-container">
                        {% for lecturer in course.lecturers %}
                        <label>Lecturer Name {{ forloop.counter }}: </label>
                        <input id="lecturer_name{{ forloop.counter }}" type="text" name="lecturer_name{{ forloop.counter }}" placeholder="Enter lecturer name" required value="{{ lecturer.lecturer_name }}" {% if request.session.user_role == 'student' or request.session.user_role == 'lecturer' %} readonly {% endif %}>
                        <br>
                        <label>Lecturer Email {{ forloop.counter }}: </label>
                        <input id="lecturer_email{{ forloop.counter }}" type="text" name="lecturer_email{{ forloop.counter }}" placeholder="Enter lecturer email" required value="{{ lecturer.lecturer_email }}" {% if request.session.user_role == 'student' or request.session.user_role == 'lecturer' %} readonly {% endif %}>
                        {% if request.session.user_role == 'admin'%}
                            <button type="button" onclick="addLecturerField()">+</button>
                        {% endif %}
                        <br>
                        {% endfor %}
                    </div>
                    <div id="venue-time-container">
                        {% for class in course.venue_time %}
                        <label>Class Venue {{ forloop.counter }}: </label>
                        <input id="class_venue{{ forloop.counter }}" type="text" name="class_venue{{ forloop.counter }}" placeholder="Enter class venue" required value="{{ class.class_venue }}" {% if request.session.user_role == 'student' or request.session.user_role == 'lecturer' %} readonly {% endif %}>
                        <br>
                        <label>Class Day {{ forloop.counter }}: </label>
                        {% if request.session.user_role == 'admin'%}
                        <select name="class_day{{ forloop.counter }}" id="class_day{{ forloop.counter }}" required>
                            <option value="">Select day</option>
                            <option value="Monday" {% if class.class_day == "Monday" %}selected{% endif %}>Monday</option>
                            <option value="Tuesday" {% if class.class_day == "Tuesday" %}selected{% endif %}>Tuesday</option>
                            <option value="Wednesday" {% if class.class_day == "Wednesday" %}selected{% endif %}>Wednesday</option>
                            <option value="Thursday" {% if class.class_day == "Thursday" %}selected{% endif %}>Thursday</option>
                            <option value="Friday" {% if class.class_day == "Friday" %}selected{% endif %}>Friday</option>
                            <option value="Saturday" {% if class.class_day == "Saturday" %}selected{% endif %}>Saturday</option>
                            <option value="Sunday" {% if class.class_day == "Sunday" %}selected{% endif %}>Sunday</option>
                        </select>
                        {% else %}
                            <input id="class_day{{ forloop.counter }}" type="text" name="class_day{{ forloop.counter }}" placeholder="Enter class day" required value="{{ class.class_day }}" readonly>
                        {% endif %}
                        <br>
                        <label>Class Start Time {{ forloop.counter }}: </label>
                        <input id="class_start_time{{ forloop.counter }}" type="time" name="class_start_time{{ forloop.counter }}" value="{{ class.class_start_time }}" required {% if request.session.user_role == 'student' or request.session.user_role == 'lecturer' %} readonly {% endif %}>
                        <br>
                        <label>Class End Time {{ forloop.counter }}: </label>
                        <input id="class_end_time{{ forloop.counter }}" type="time" name="class_end_time{{ forloop.counter }}" value="{{ class.class_end_time }}" required {% if request.session.user_role == 'student' or request.session.user_role == 'lecturer' %} readonly {% endif %}>
                        {% if request.session.user_role == 'admin'%}
                            <button type="button" onclick="addVenueTimeField()">+</button>
                        {% endif %}
                        <br>
                        {% endfor %}
                        {% if request.session.user_role == 'admin'%}
                            <button type="submit" class="btn btn-primary">Update Course</button>
                        {% endif %}
                    </div>
                </form>
                
                {% if request.session.user_role == 'admin' or request.session.user_role == 'student'%}
                    <form id="deleteCourseForm" method="POST" action="{% url 'delete-course' semester_year=course.semester_year course_code=course_code %}">
                        {% csrf_token %}
                        <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                            {% if request.session.user_role == 'admin'%}Delete Course {% else %}Unenroll From Course{% endif %}
                        </button>
                    </form>
                {% endif %}
                {% if request.session.user_role == 'admin' or request.session.user_role == 'lecturer' %}
                    <div class="enrolled-students-section">
                        <h3>Enrolled Students</h3>
                        <div class="export-buttons mb-3">
                            <div class="btn-group" role="group" aria-label="Export Options">
                                <button type="button" class="btn btn-secondary" onclick="exportTable('csv')">
                                    <i class="fas fa-file-csv"></i> Export CSV
                                </button>
                                <button type="button" class="btn btn-success" onclick="exportTable('excel')">
                                    <i class="fas fa-file-excel"></i> Export Excel
                                </button>
                                <button type="button" class="btn btn-danger" onclick="exportTable('pdf')">
                                    <i class="fas fa-file-pdf"></i> Export PDF
                                </button>
                            </div>
                            {% if request.session.user_role == 'admin' or request.session.user_role == 'lecturer' %}
                            <div class="upload-button ms-2">
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadMarksModal">
                                    <i class="fas fa-upload"></i> Upload Marks CSV
                                </button>
                            </div>
                            <div class="modal fade" id="uploadMarksModal" tabindex="-1" aria-labelledby="uploadMarksModalLabel" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="uploadMarksModalLabel">Upload Marks CSV</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <form id="uploadMarksForm" method="POST" action="{% url 'upload-marks' semester_year=semester_year course_code=course_code %}" enctype="multipart/form-data">
                                                {% csrf_token %}
                                                <div class="mb-3">
                                                    <label for="csvFile" class="form-label">Choose CSV File</label>
                                                    <input type="file" class="form-control" id="csvFile" name="csvFile" accept=".csv" required>
                                                </div>
                                                <div class="mb-3">
                                                    <p><strong>CSV Format:</strong></p>
                                                    <p>Matrix Number{% for coursework in course.courseworks.values %}, {{ coursework.type }}{% endfor %}</p>
                                                    <small class="text-muted">Note: First row should be headers. Marks should be numbers between 0 and the maximum mark for each coursework.</small>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                    <button type="submit" class="btn btn-primary">Upload</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        <div class="search-bar mb-3">
                            <input 
                                type="text" 
                                id="studentSearch" 
                                class="form-control" 
                                placeholder="Search students by name, matrix number, or email"
                                onkeyup="searchTable()"
                            >
                        </div>
                        <table class="table" id="marksTable">
                            <thead>
                                <tr>
                                    <th data-column="0" data-type="number" style="cursor: pointer;">
                                        No. <span class="sort-icon"></span>
                                    </th>
                                    <th data-column="1" data-type="text" style="cursor: pointer;">
                                        Name <span class="sort-icon"></span>
                                    </th>
                                    <th data-column="2" data-type="text" style="cursor: pointer;">
                                        Matrix Number <span class="sort-icon"></span>
                                    </th>
                                    <th data-column="3" data-type="text" style="cursor: pointer;">
                                        Email <span class="sort-icon"></span>
                                    </th>
                                    {% for coursework in course.courseworks %}
                                        <th data-column="{{ forloop.counter|add:3 }}" data-type="number" style="cursor: pointer;">
                                            {{ coursework.type }} ({{ coursework.total_mark }}%) <span class="sort-icon"></span>
                                        </th>
                                    {% endfor %}
                                    <th data-column="{{ course.courseworks|length|add:4 }}" data-type="number" style="cursor: pointer;">
                                        Total Coursework Mark ({{ total_marks }}%) <span class="sort-icon"></span>
                                    </th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if enrolled_students %}
                                    {% for student in enrolled_students %}
                                        <tr>
                                            <td style="text-align: center;">{{ forloop.counter }}</td>
                                            <td>{{ student.name }}</td>
                                            <td style="text-align: center;">{{ student.matrix }}</td>
                                            <td>{{ student.email }}</td>

                                            {% for coursework in course.courseworks %}
                                                <td style="text-align: center;">
                                                    {% if coursework.type in student.marks %}
                                                        {{ student.marks|get_item:coursework.type }}
                                                    {% else %}
                                                        0
                                                    {% endif %}
                                                </td>
                                            {% endfor %}
                                            <td style="text-align: center;">{{ student.total_mark|default:0 }}</td>
                                            <td style="text-align: center;">
                                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#marksModal{{ student.email|slugify }}">
                                                    Edit Marks
                                                </button>
                                                {% if request.session.user_role == 'admin' %}
                                                    <button type="button" class="btn btn-danger" 
                                                        onclick="confirmUnenroll('{{ student.email }}', '{{ course_code }}', '{{ course.academic_year }}', '{{ semester }}')">
                                                        Unenroll
                                                    </button>
                                                {% endif %}
                                            </td>
                                        </tr>

                                        <!-- Marks Modal for each student -->
                                        <div class="modal fade" id="marksModal{{ student.email|slugify }}" tabindex="-1" aria-labelledby="marksModalLabel{{ student.email|slugify }}" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="marksModalLabel{{ student.email|slugify }}">
                                                            Update Marks for {{ student.name }}
                                                        </h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <form method="POST" action="{% url 'update-marks' semester_year=semester_year course_code=course_code student_email=student.email %}">
                                                            {% csrf_token %}
                                                            {% for coursework in course.courseworks %}
                                                                <div class="mb-3">
                                                                    <label for="mark_{{ coursework.type|slugify }}" class="form-label">
                                                                        {{ coursework.type }} (Max: {{ coursework.total_mark }}%)
                                                                    </label>
                                                                    <input type="number" 
                                                                           class="form-control" 
                                                                           id="mark_{{ coursework.type|slugify }}"
                                                                           name="mark_{{ coursework.type|slugify }}"
                                                                           min="0" 
                                                                           max="{{ coursework.total_mark }}"
                                                                           step="0.01"
                                                                           value="{% for key, value in student.marks.items %}{% if key == coursework.type %}{{ value }}{% endif %}{% endfor %}">
                                                                </div>
                                                            {% endfor %}
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                                <button type="submit" class="btn btn-primary">Save Changes</button>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="{{ 5|add:course.courseworks|length }}" class="text-center">No students enrolled in this course</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                {% elif request.session.user_role == 'student' %}
                    <div class="enrolled-students-section">
                        <h3>Your Course Marks</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    {% for coursework in course.courseworks %}
                                        <th>{{ coursework.type }} ({{ coursework.total_mark }}%)</th>
                                    {% endfor %}
                                    <th>Total Coursework Mark ({{ total_marks }}%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in enrolled_students %}
                                    {% if student.email == request.session.user_email %}
                                        <tr>
                                            {% for coursework in course.courseworks %}
                                                <td style="text-align: center;">
                                                    {% if coursework.type in student.marks %}
                                                        {{ student.marks|get_item:coursework.type }}
                                                    {% else %}
                                                        0
                                                    {% endif %}
                                                </td>
                                            {% endfor %}
                                            <td style="text-align: center;">{{ student.total_mark|default:0 }}</td>
                                        </tr>
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
                {% endfor %}
            {% endif %}
        </section>
        </main>

        {% include 'footer.html' %} 
    </div>
    <script src="{% static 'js/backend.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script>
    function confirmDelete() {
        Swal.fire({
            title: 'Are you sure?',
            text: "{% if request.session.user_role == 'admin' %}This will delete the course for all students!{% else %}You will be unenrolled from this course!{% endif %}",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                submitDeleteForm();
            }
        });
    }

    async function submitDeleteForm() {
        try {
            const form = document.getElementById('deleteCourseForm');
            const formData = new FormData(form);
            
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                await Swal.fire({
                    icon: 'success',
                    title: 'Deleted!',
                    text: data.message,
                    timer: 2000,
                    showConfirmButton: false
                });
                window.location.href = "{% url 'academic' %}";
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'An error occurred while deleting the course.'
                });
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred while processing your request.'
            });
        }
    }

    async function handleUpdateSubmit(event) {
        event.preventDefault();
        
        try {
            const form = document.getElementById('updateCourseForm');
            const formData = new FormData(form);
            
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'Accept': 'application/json'
                }
            });
            
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                const data = await response.json();
                
                if (data.status === 'success') {
                    await Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: data.message,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    window.location.reload();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message || 'An error occurred while updating the course.'
                    });
                }
            } else {
                const text = await response.text();
                console.error('Non-JSON response:', text);
                throw new Error('Server returned non-JSON response');
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred while processing your request.'
            });
        }
        return false;
    }

    function exportTable(format) {
        const table = document.getElementById('marksTable');
        const courseCode = '{{ course_code }}';
        const fileName = `${courseCode}_marks`;

        // Get headers (exclude last column - Actions)
        const headers = Array.from(table.querySelectorAll('thead th'))
            .slice(0, -1)  // Remove last header
            .map(th => th.textContent.trim());
        
        // Get data (exclude last column - Actions)
        const rows = Array.from(table.querySelectorAll('tbody tr')).map(row => 
            Array.from(row.querySelectorAll('td'))
                .slice(0, -1)  // Remove last cell
                .map(cell => cell.textContent.trim())
        );

        switch(format) {
            case 'csv':
                exportCSV(headers, rows, fileName);
                break;
            case 'excel':
                exportExcel(headers, rows, fileName);
                break;
            case 'pdf':
                exportPDF(headers, rows, fileName);
                break;
        }
    }

    function exportCSV(headers, rows, fileName) {
        const csvContent = [
            headers.join(','),
            ...rows.map(row => row.join(','))
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${fileName}.csv`;
        link.click();
    }

    function exportExcel(headers, rows, fileName) {
        const worksheet = XLSX.utils.aoa_to_sheet([headers, ...rows]);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Marks');
        XLSX.writeFile(workbook, `${fileName}.xlsx`);
    }

    function exportPDF(headers, rows, fileName) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.autoTable({
            head: [headers],
            body: rows,
            theme: 'grid',
            styles: { fontSize: 8 },
            headStyles: { fillColor: [66, 139, 202] }
        });

        doc.save(`${fileName}.pdf`);
    }

    function confirmUnenroll(studentEmail, courseCode, academicYear, semester) {
        Swal.fire({
            title: 'Are you sure?',
            text: "This will unenroll the student from this course!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, unenroll!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                unenrollStudent(studentEmail, courseCode, academicYear, semester);
            }
        });
    }

    async function unenrollStudent(studentEmail, courseCode, academicYear, semester) {
        try {
            const response = await fetch('/unenroll-student/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    student_email: studentEmail,
                    course_code: courseCode,
                    academic_year: academicYear,
                    semester: semester
                })
            });

            const data = await response.json();
            
            if (data.status === 'success') {
                await Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: 'Student has been unenrolled from the course.',
                    timer: 2000,
                    showConfirmButton: false
                });
                window.location.reload();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'An error occurred while unenrolling the student.'
                });
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred while processing your request.'
            });
        }
    }

    function searchTable() {
        const searchInput = document.getElementById('studentSearch');
        const filter = searchInput.value.toLowerCase();
        const table = document.getElementById('marksTable');
        const rows = table.getElementsByTagName('tr');

        // Loop through all table rows (skip header)
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const cells = row.getElementsByTagName('td');
            if (cells.length === 0) continue; // Skip if no cells (like in empty message row)

            // Check name (cell 1), matrix (cell 2), and email (cell 3)
            const name = cells[1].textContent || cells[1].innerText;
            const matrix = cells[2].textContent || cells[2].innerText;
            const email = cells[3].textContent || cells[3].innerText;
            
            const matchFound = 
                name.toLowerCase().includes(filter) ||
                matrix.toLowerCase().includes(filter) ||
                email.toLowerCase().includes(filter);

            row.style.display = matchFound ? '' : 'none';
        }
    }

    let lastSortedColumn = -1;
    let isAscending = true;

    function sortTable(columnIndex, type) {
        const table = document.getElementById('marksTable');
        const tbody = table.getElementsByTagName('tbody')[0];
        const rows = Array.from(tbody.getElementsByTagName('tr'));
        const headers = table.getElementsByTagName('th');

        // Reset all headers except Actions
        for (let i = 0; i < headers.length - 1; i++) {
            headers[i].classList.remove('asc', 'desc');
        }

        // Determine sort direction
        if (lastSortedColumn === columnIndex) {
            isAscending = !isAscending;
        } else {
            isAscending = false;
        }
        lastSortedColumn = columnIndex;

        // Add sort indicator
        headers[columnIndex].classList.add(isAscending ? 'asc' : 'desc');

        // Sort rows
        rows.sort((a, b) => {
            let aValue = a.cells[columnIndex].textContent.trim();
            let bValue = b.cells[columnIndex].textContent.trim();

            if (type === 'number') {
                // Convert to numbers and handle empty/non-numeric values
                aValue = parseFloat(aValue) || 0;
                bValue = parseFloat(bValue) || 0;
                return isAscending ? aValue - bValue : bValue - aValue;
            } else {
                // Text comparison
                return isAscending 
                    ? aValue.localeCompare(bValue)
                    : bValue.localeCompare(aValue);
            }
        });

        // Reorder rows in the table
        rows.forEach(row => tbody.appendChild(row));

        // Update row numbers based on sort direction
        rows.forEach((row, index) => {
            row.cells[0].textContent = isAscending ? index + 1 : rows.length - index;
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const table = document.getElementById('marksTable');
        const headers = table.getElementsByTagName('th');
        
        for (let header of headers) {
            if (header.dataset.column) {
                header.addEventListener('click', function() {
                    sortTable(parseInt(this.dataset.column), this.dataset.type);
                });
            }
        }
    });

    document.getElementById('uploadMarksForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        try {
            const response = await fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                await Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: data.message,
                    timer: 2000,
                    showConfirmButton: false
                });
                window.location.reload();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'An error occurred while uploading marks.'
                });
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred while processing your request.'
            });
        }
    });
    </script>
</body>
</html>
