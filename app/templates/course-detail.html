{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS SETS</title>
    <link rel="stylesheet" href="{% static 'css/navbar.css' %}">  
    <link rel="stylesheet" href="{% static 'css/header.css' %}">  
    <link rel="stylesheet" href="{% static 'css/style.css' %}">  
    <link rel="stylesheet" href="{% static 'css/footer.css' %}">
    <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}">
    <style>
    .enrolled-students-section {
        margin-top: 2rem;
        margin-bottom: 2rem;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    .table th,
    .table td {
        padding: 0.75rem;
        border: 1px solid #dee2e6;
        text-align: left;
    }

    .table thead th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }

    .table tbody tr:nth-of-type(odd) {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .table tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.075);
    }

    .text-center {
        text-align: center;
    }
    </style>
</head>
<body>
    <div class="container">

        {% include 'navbar.html' %} 

        {% include 'header.html' %} 

        <main>
          <section class="content">
            {% if error %}
            <p>{{ error }}</p>
            {% else %}
                {% for course in courses %}
                <h2 class="section-title">{{ course_code }} : {{course.course_name}}</h2>
                <form id="updateCourseForm" method="POST" action="{% url 'course-detail' semester_year=course.semester_year course_code=course_code %}" onsubmit="return handleUpdateSubmit(event)">
                    {% csrf_token %}
                    <label>Academic Year: </label>
                    <input id="academic_year" type="text" name="academic_year" placeholder="Enter academic year" maxlength="9" required value="{{ course.academic_year }}" readonly>
                    <br>
                    <label>Semester: </label>
                    {% if request.session.user_role == 'admin'%}
                    <select name="semester" id="semester" required readonly>
                        <option value="" disabled>Select semester</option>
                        <option value="1" {% if semester == "1" %}selected {% else %} disabled {% endif %}>1</option>
                        <option value="2" {% if semester == "2" %}selected {% else %} disabled {% endif %}>2</option>
                    </select>
                    {% else %}
                        <input id="semester" type="text" name="semester" placeholder="Enter semester" maxlength="1" required value="{{ semester }}" readonly>
                    {% endif %}
                    <br>
                    <label>Course Code: </label>
                    <input id="course_code" type="text" name="course_code" placeholder="Enter course code" required value="{{ course_code }}" readonly>
                    <br>
                    <label>Course Name: </label>
                    <input id="course_name" type="text" name="course_name" placeholder="Enter course name" required value="{{ course.course_name }}" {% if request.session.user_role == 'student' or request.session.user_role == 'lecturer' %} readonly {% endif %}>
                    <br>
                    <div id="lecturer-container">
                        {% for lecturer in course.lecturers %}
                        <label>Lecturer Name {{ forloop.counter }}: </label>
                        <input id="lecturer_name{{ forloop.counter }}" type="text" name="lecturer_name{{ forloop.counter }}" placeholder="Enter lecturer name" required value="{{ lecturer.lecturer_name }}" {% if request.session.user_role == 'student' or request.session.user_role == 'lecturer' %} readonly {% endif %}>
                        <br>
                        <label>Lecturer Email {{ forloop.counter }}: </label>
                        <input id="lecturer_email{{ forloop.counter }}" type="text" name="lecturer_email{{ forloop.counter }}" placeholder="Enter lecturer email" required value="{{ lecturer.lecturer_email }}" {% if request.session.user_role == 'student' or request.session.user_role == 'lecturer' %} readonly {% endif %}>
                        {% if request.session.user_role == 'admin'%}
                            <button type="button" onclick="addLecturerField()">+</button>
                        {% endif %}
                        <br>
                        {% endfor %}
                    </div>
                    <div id="venue-time-container">
                        {% for class in course.venue_time %}
                        <label>Class Venue {{ forloop.counter }}: </label>
                        <input id="class_venue{{ forloop.counter }}" type="text" name="class_venue{{ forloop.counter }}" placeholder="Enter class venue" required value="{{ class.class_venue }}" {% if request.session.user_role == 'student' or request.session.user_role == 'lecturer' %} readonly {% endif %}>
                        <br>
                        <label>Class Day {{ forloop.counter }}: </label>
                        {% if request.session.user_role == 'admin'%}
                        <select name="class_day{{ forloop.counter }}" id="class_day{{ forloop.counter }}" required>
                            <option value="">Select day</option>
                            <option value="Monday" {% if class.class_day == "Monday" %}selected{% endif %}>Monday</option>
                            <option value="Tuesday" {% if class.class_day == "Tuesday" %}selected{% endif %}>Tuesday</option>
                            <option value="Wednesday" {% if class.class_day == "Wednesday" %}selected{% endif %}>Wednesday</option>
                            <option value="Thursday" {% if class.class_day == "Thursday" %}selected{% endif %}>Thursday</option>
                            <option value="Friday" {% if class.class_day == "Friday" %}selected{% endif %}>Friday</option>
                            <option value="Saturday" {% if class.class_day == "Saturday" %}selected{% endif %}>Saturday</option>
                            <option value="Sunday" {% if class.class_day == "Sunday" %}selected{% endif %}>Sunday</option>
                        </select>
                        {% else %}
                            <input id="class_day{{ forloop.counter }}" type="text" name="class_day{{ forloop.counter }}" placeholder="Enter class day" required value="{{ class.class_day }}" readonly>
                        {% endif %}
                        <br>
                        <label>Class Start Time {{ forloop.counter }}: </label>
                        <input id="class_start_time{{ forloop.counter }}" type="time" name="class_start_time{{ forloop.counter }}" value="{{ class.class_start_time }}" required {% if request.session.user_role == 'student' or request.session.user_role == 'lecturer' %} readonly {% endif %}>
                        <br>
                        <label>Class End Time {{ forloop.counter }}: </label>
                        <input id="class_end_time{{ forloop.counter }}" type="time" name="class_end_time{{ forloop.counter }}" value="{{ class.class_end_time }}" required {% if request.session.user_role == 'student' or request.session.user_role == 'lecturer' %} readonly {% endif %}>
                        {% if request.session.user_role == 'admin'%}
                            <button type="button" onclick="addVenueTimeField()">+</button>
                        {% endif %}
                        <br>
                        {% endfor %}
                        {% if request.session.user_role == 'admin'%}
                            <button type="submit" class="btn btn-primary">Update Course</button>
                        {% endif %}
                    </div>
                </form>
                
                {% if request.session.user_role == 'admin' or request.session.user_role == 'student'%}
                    <form id="deleteCourseForm" method="POST" action="{% url 'delete-course' semester_year=course.semester_year course_code=course_code %}">
                        {% csrf_token %}
                        <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                            {% if request.session.user_role == 'admin'%}Delete Course {% else %}Unenroll From Course{% endif %}
                        </button>
                    </form>
                {% endif %}
                {% if request.session.user_role == 'admin' or request.session.user_role == 'lecturer' %}
                    <div class="enrolled-students-section">
                        <h3>Enrolled Students</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>No.</th>
                                    <th>Name</th>
                                    <th>Matrix Number</th>
                                    <th>Email</th>
                                    {% for coursework in course.courseworks %}
                                        <th>{{ coursework.type }} ({{ coursework.total_mark }}%)</th>
                                    {% endfor %}
                                    <th>Total Coursework Mark ({{ total_marks }}%)</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if enrolled_students %}
                                    {% for student in enrolled_students %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            <td>{{ student.name }}</td>
                                            <td>{{ student.matrix }}</td>
                                            <td>{{ student.email }}</td>

                                            {% for coursework in course.courseworks %}
                                                {% for key, value in student.marks.items %}
                                                    {% if key == coursework.type %}
                                                        <td>{{ value }}</td>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                            <td>{{ student.total_mark }}</td>
                                            <td>
                                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#marksModal{{ student.email|slugify }}">
                                                    Edit Marks
                                                </button>
                                            </td>
                                        </tr>

                                        <!-- Marks Modal for each student -->
                                        <div class="modal fade" id="marksModal{{ student.email|slugify }}" tabindex="-1" aria-labelledby="marksModalLabel{{ student.email|slugify }}" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="marksModalLabel{{ student.email|slugify }}">
                                                            Update Marks for {{ student.name }}
                                                        </h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <form method="POST" action="{% url 'update-marks' semester_year=semester_year course_code=course_code student_email=student.email %}">
                                                            {% csrf_token %}
                                                            {% for coursework in course.courseworks %}
                                                                <div class="mb-3">
                                                                    <label for="mark_{{ coursework.type|slugify }}" class="form-label">
                                                                        {{ coursework.type }} (Max: {{ coursework.total_mark }}%)
                                                                    </label>
                                                                    <input type="number" 
                                                                           class="form-control" 
                                                                           id="mark_{{ coursework.type|slugify }}"
                                                                           name="mark_{{ coursework.type|slugify }}"
                                                                           min="0" 
                                                                           max="{{ coursework.total_mark }}"
                                                                           step="0.01"
                                                                           value="{% for key, value in student.marks.items %}{% if key == coursework.type %}{{ value }}{% endif %}{% endfor %}">
                                                                </div>
                                                            {% endfor %}
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                                <button type="submit" class="btn btn-primary">Save Changes</button>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="{{ 5|add:course.courseworks|length }}" class="text-center">No students enrolled in this course</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                {% elif request.session.user_role == 'student' %}
                    <div class="enrolled-students-section">
                        <h3>Your Course Marks</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    {% for coursework in course.courseworks %}
                                        <th>{{ coursework.type }} ({{ coursework.total_mark }}%)</th>
                                    {% endfor %}
                                    <th>Total Coursework Mark ({{ total_marks }}%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in enrolled_students %}
                                    {% if student.email == request.session.user_email %}
                                        <tr>
                                            {% for coursework in course.courseworks %}
                                                {% for key, value in student.marks.items %}
                                                    {% if key == coursework.type %}
                                                        <td>{{ value }}</td>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                            <td>{{ student.total_mark }}</td>
                                        </tr>
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
                {% endfor %}
            {% endif %}
        </section>
        </main>

        {% include 'footer.html' %} 
    </div>
    <script src="{% static 'js/backend.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script>
    function confirmDelete() {
        Swal.fire({
            title: 'Are you sure?',
            text: "{% if request.session.user_role == 'admin' %}This will delete the course for all students!{% else %}You will be unenrolled from this course!{% endif %}",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                submitDeleteForm();
            }
        });
    }

    async function submitDeleteForm() {
        try {
            const form = document.getElementById('deleteCourseForm');
            const formData = new FormData(form);
            
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                await Swal.fire({
                    icon: 'success',
                    title: 'Deleted!',
                    text: data.message,
                    timer: 2000,
                    showConfirmButton: false
                });
                window.location.href = "{% url 'academic' %}";
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'An error occurred while deleting the course.'
                });
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred while processing your request.'
            });
        }
    }

    async function handleUpdateSubmit(event) {
        event.preventDefault();
        
        try {
            const form = document.getElementById('updateCourseForm');
            const formData = new FormData(form);
            
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'Accept': 'application/json'
                }
            });
            
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                const data = await response.json();
                
                if (data.status === 'success') {
                    await Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: data.message,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    window.location.reload();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message || 'An error occurred while updating the course.'
                    });
                }
            } else {
                const text = await response.text();
                console.error('Non-JSON response:', text);
                throw new Error('Server returned non-JSON response');
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred while processing your request.'
            });
        }
        return false;
    }
    </script>
</body>
</html>
