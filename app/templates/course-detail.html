{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS SETS</title>
    <link rel="stylesheet" href="{% static 'css/navbar.css' %}">  
    <link rel="stylesheet" href="{% static 'css/header.css' %}">  
    <link rel="stylesheet" href="{% static 'css/style.css' %}">  
    <link rel="stylesheet" href="{% static 'css/footer.css' %}">
    <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <style>
    /* Section Title */
    .section-title {
        font-size: 1.75rem;
        color: #1e293b;
        margin-bottom: 2rem;
        font-weight: 600;
    }

    /* Form Styling */
    #updateCourseForm {
        background-color: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 2rem;
    }

    #updateCourseForm label {
        display: block;
        font-weight: 500;
        color: #1e293b;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    #updateCourseForm input,
    #updateCourseForm select {
        width: 100%;
        padding: 0.6rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.95rem;
        background-color: #f8fafc;
        color: #1e293b;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    #updateCourseForm input:focus,
    #updateCourseForm select:focus {
        border-color: #4361ee;
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        outline: none;
    }

    /* Container Sections */
    #lecturer-container,
    #venue-time-container {
        background-color: #fae0bb;
        padding: 1.2rem;
        border-radius: 12px;
        margin-bottom: 1rem;
        border: 1px solid #e2e8f0;
    }

    /* Table Styling */
    .table {
        background-color: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    /* Table Header Styling */
    .table th {
        background-color: #f9c784;  /* Changed from #4361ee to match theme */
        color: #1e293b;  /* Dark color for better visibility */
        font-weight: 600;
        padding: 1rem;
        font-size: 0.95rem;
        border-bottom: 2px solid #e2e8f0;
        white-space: nowrap;
        text-align: center;
    }

    .table td {
        padding: 0.8rem 1rem;
        color: #1e293b;
        border-bottom: 1px solid #e2e8f0;
        font-size: 0.95rem;
    }

    .table tbody tr:hover {
        background-color: #f8fafc;
    }

    /* Export Buttons */
    .export-buttons {
        display: flex;
        gap: 0.8rem;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }

    /* Button Group Styling */
    .btn-group {
        display: flex;
        gap: 0.5rem;
    }

    /* Individual Button Styling */
    .btn {
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border: none;
    }

    .btn i {
        font-size: 1rem;
    }

    /* Button Colors */
    .btn-secondary {
        background-color: #64748b;
        color: white;
    }

    .btn-success {
        background-color: #10b981;
        color: white;
    }

    .btn-danger {
        background-color: #ef4444;
        color: white;
    }

    .btn-primary {
        background-color: #4361ee;
        color: white;
    }

    .btn-warning {
        background-color: #f59e0b;
        color: white;
    }

    /* Hover Effects */
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Upload Button Container */
    .upload-button {
        display: inline-flex;
    }

    /* Prediction Button Container */
    .prediction-button {
        display: inline-flex;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .export-buttons {
            flex-direction: column;
            align-items: stretch;
        }

        .btn-group {
            flex-direction: column;
        }

        .upload-button,
        .prediction-button {
            width: 100%;
        }
    }

    /* .modal-content {
        border-radius: 12px;
        border: none;
    }

    .modal-header {
        background-color: #4361ee;
        color: white;
        border-radius: 12px 12px 0 0;
        padding: 1rem 1.5rem;
    }

    .modal-body {
        padding: 1.5rem;
        background-color: #f9c784;
    } */

    /* Search Bar */
    .search-bar {
        max-width: 500px;
        margin: 1rem auto;
    }

    .search-bar input {
        width: 100%;
        padding: 0.8rem 1.2rem;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }

    .search-bar input:focus {
        border-color: #4361ee;
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        outline: none;
    }

    /* Enrolled Students Section */
    .enrolled-students-section {
        background-color: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin-top: 2rem;
    }

    .enrolled-students-section h3 {
        color: #1e293b;
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
        font-weight: 600;
    }

    .enrolled-students-section {
        margin-top: 2rem;
        margin-bottom: 2rem;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    .table th,
    .table td {
        padding: 0.75rem;
        border: 1px solid #dee2e6;
        text-align: left;
    }

    .table thead th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        text-align: center;
    }

    .table tbody tr:nth-of-type(odd) {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .table tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.075);
    }

    .text-center {
        text-align: center;
    }

    .search-bar {
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
    }

    .search-bar input {
        padding: 8px 15px;
        border-radius: 4px;
        border: 1px solid #ddd;
        width: 100%;
    }

    .search-bar input:focus {
        outline: none;
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }

    .sort-icon::after {
        content: '↕️';
        margin-left: 5px;
        opacity: 0.3;
    }

    th.asc .sort-icon::after {
        content: '↑';
        opacity: 1;
    }

    th.desc .sort-icon::after {
        content: '↓';
        opacity: 1;
    }

    th {
        user-select: none;
    }

    .progress {
        margin-bottom: 0;
    }

    .badge {
        padding: 8px 12px;
    }

    .coursework-breakdown .progress {
        height: 8px;
        margin-bottom: 4px;
    }

    #predictionTable th, 
    #predictionTable td {
        vertical-align: middle;
    }

    
    .accordion {
        background-color: #eee;
        color: #444;
        cursor: pointer;
        padding: 18px;
        width: 100%;
        border: none;
        text-align: left;
        outline: none;
        font-size: 15px;
        transition: 0.4s;
      }

      .active, .accordion:hover {
        background-color: #ccc;
      }

      .accordion:after {
        content: '\002B';
        color: #777;
        font-weight: bold;
        float: right;
        margin-left: 5px;
      }

      .active:after {
        content: "\2212";
      }

      .panel {
        padding: 0 18px;
        background-color: white;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.2s ease-out;
      }

      .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
    }
    
    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .form-group #editor {
        height: 300px;
        margin-bottom: 20px;
    }

    .form-control {
        border: 2px solid black !important;
        border-radius: 4px;
        padding: 10px;
        transition: border-color 0.3s;
    }
    
    .form-title {
        font-size: 20px;
        font-weight: bold;
        color: #4E598C;
        margin-left: auto;
        margin-right: auto;
    }

    .announcement-title {
        background-color: #F9C784;
        color: #4E598C;
        cursor: pointer;
        padding: 18px;
        width: 100%;
        border: none;
        text-align: left;
        outline: none;
        font-size: 15px; 
        transition: 0.4s;
    }
    
    .announcement-title:hover {
        background-color: #e39023;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .btn-show-announcement {
        background-color: #4E598C;
        color: white;
        margin-top: 10px;
    }

    .sort-icon {
        display: inline-block;
        width: 12px;
        height: 12px;
        margin-left: 5px;
        vertical-align: middle;
        opacity: 0.6;
    }

    .table th[data-column] {
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .table th[data-column]:hover {
        background-color: #f8b862; 
        color: #000000; 
    }

    .table th {
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;  /* Adjust based on your needs */
    }

    /* Section Header Container */
    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.2rem;
    }

    .section-header h2 {
        margin: 0;
        font-size: 1.2rem;
        color: #1e293b;
        font-weight: 600;
    }

    /* Plus and Minus Button Styling */
    button[onclick*="addLecturerField"],
    button[onclick*="addVenueTimeField"],
    button[onclick*="removeLecturerField"],
    button[onclick*="removeVenueTimeField"] {
        background-color: #4361ee;
        color: white;
        border: none;
        border-radius: 6px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 0;
        font-size: 1.2rem;
        font-weight: 500;
    }

    /* Minus Button Specific Style */
    button[onclick*="removeLecturerField"],
    button[onclick*="removeVenueTimeField"] {
        background-color: #ef4444;  /* Red color for remove buttons */
        margin-left: 0.5rem;
    }

    /* Hover Effects */
    button[onclick*="addLecturerField"]:hover,
    button[onclick*="addVenueTimeField"]:hover {
        background-color: #3151e8;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    button[onclick*="removeLecturerField"]:hover,
    button[onclick*="removeVenueTimeField"]:hover {
        background-color: #dc2626;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Input Group Styling */
    .input-group {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }

    .input-group input,
    .input-group select {
        flex: 1;
        margin-bottom: 0;
    }

    /* Action Buttons Container */
    .table td:last-child {
        text-align: center;
        white-space: nowrap;
        width: 150px; /* Fixed width for actions column */
    }

    /* Action Buttons Styling */
    .table .btn {
        width: 100px; /* Fixed width for buttons */
        margin: 0.25rem;
        padding: 0.5rem 0;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.3s ease;
    }

    .table .btn-primary {
        background-color: #4361ee;
        border: none;
    }

    .table .btn-danger {
        background-color: #ef4444;
        border: none;
    }

    .table .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Button Group Layout */
    .action-buttons-group {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    /* Prediction Modal Styling */
    #predictionResultsModal .modal-dialog {
        max-width: 90%;
    }

    #predictionResultsModal .modal-content {
        border-radius: 12px;
        border: none;
        background-color: #f8fafc;
    }

    #predictionResultsModal .modal-header {
        background-color: #4361ee;
        color: white;
        border-radius: 12px 12px 0 0;
        padding: 1rem 1.5rem;
    }

    #predictionResultsModal .modal-body {
        padding: 1.5rem;
        background-color: white;
        color: #1e293b;
    }

    /* Risk Summary Card */
    .risk-summary-card {
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .risk-summary-card h6 {
        color: #1e293b;
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }

    .risk-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .stat-item {
        background-color: white;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }

    .stat-label {
        color: #64748b;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .stat-value {
        color: #1e293b;
        font-size: 1.2rem;
        font-weight: 600;
    }

    /* Prediction Table Styling */
    #predictionTable {
        background-color: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    #predictionTable th {
        background-color: #f9c784;
        color: #1e293b;
        font-weight: 600;
        padding: 1rem;
        font-size: 0.95rem;
        text-align: center;  /* Center align header text */
        white-space: nowrap;
        vertical-align: middle;
    }

    #predictionTable td {
        padding: 1rem;
        color: #1e293b;
        font-size: 0.95rem;
        border-bottom: 1px solid #e2e8f0;
        text-align: center;  /* Center align cell content */
        vertical-align: middle;
    }

    /* Actions Column Width */
    #predictionTable th:last-child,
    #predictionTable td:last-child {
        width: 120px;
    }

    /* Alert Button Styling */
    .alert-btn {
        width: 100px;  /* Fixed width matching other buttons */
        padding: 0.5rem 0;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.3s ease;
        background-color: #4361ee;
        color: white;
        border: none;
        margin: 0.25rem;
        text-decoration: none;
        cursor: pointer;
    }

    .alert-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        background-color: #3151e8;
    }

    /* Text Truncation for Long Content */
    #predictionTable td {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Risk Analysis Column */
    .risk-badge {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-weight: 500;
        text-align: center;
        display: inline-block;
    }

    .risk-high {
        background-color: #fee2e2;
        color: #dc2626;
    }

    .risk-medium {
        background-color: #fef3c7;
        color: #d97706;
    }

    .risk-low {
        background-color: #dcfce7;
        color: #16a34a;
    }

    /* Modal Footer */
    #predictionResultsModal .modal-footer {
        border-top: 1px solid #e2e8f0;
        padding: 1rem 1.5rem;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .risk-stats {
            grid-template-columns: 1fr;
        }
    }

    /* Alert Button in Prediction Table */
    .btn-warning.alert-btn {
        width: 140px;  /* Fixed width to fit content */
        height: 35px;  /* Fixed height */
        padding: 0 0.75rem;
        font-size: 0.85rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;  /* Space between icon and text */
        border-radius: 6px;
        transition: all 0.3s ease;
        background-color: #f59e0b;  /* Warning color */
        color: white;
        border: none;
        margin: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
    }

    .btn-warning.alert-btn i {
        font-size: 0.85rem;  /* Match icon size with text */
    }

    .btn-warning.alert-btn:hover {
        background-color: #d97706;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Ensure the table cell can accommodate the button */
    #predictionTable td:last-child {
        width: 150px;  /* Slightly wider than button to provide padding */
        padding: 0.5rem;
        text-align: center;
    }

    /* Progress Column Styling */
    #predictionTable td:nth-child(3) {
        width: 12%;
        text-align: center;
        padding: 1rem;
        vertical-align: middle;
    }

    /* Progress Bar Container */
    .progress {
        width: 100%;
        height: 20px;  /* Increased height for better visibility */
        background-color: #e2e8f0;
        border-radius: 10px;
        margin: 0 auto;  /* Center the progress bar */
        overflow: hidden;
    }

    /* Progress Bar */
    .progress-bar {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.85rem;
        font-weight: 500;
        transition: width 0.3s ease;
        border-radius: 10px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* Progress Bar Colors */
    .progress-bar.bg-success {
        background-color: #10b981;
    }

    .progress-bar.bg-warning {
        background-color: #f59e0b;
    }

    .progress-bar.bg-danger {
        background-color: #ef4444;
    }

    /* Progress Text */
    .progress-bar {
        position: relative;
        min-width: 40px;  /* Ensure percentage is always visible */
    }

    /* For very low percentages, show text outside the bar */
    .progress-bar[style*="width: 0%"],
    .progress-bar[style*="width: 1%"],
    .progress-bar[style*="width: 2%"],
    .progress-bar[style*="width: 3%"],
    .progress-bar[style*="width: 4%"],
    .progress-bar[style*="width: 5%"] {
        color: #1e293b;  /* Dark color for better visibility */
    }

    /* Global Modal Close Button Styling */
    .modal .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);  /* Makes the button white */
        opacity: 0.8;  /* Slightly transparent */
        transition: opacity 0.3s ease;
    }

    .modal .btn-close:hover {
        opacity: 1;  /* Full opacity on hover */
    }

    .modal .btn-close:focus {
        box-shadow: 0 0 0 0.25rem rgba(255, 255, 255, 0.25);  /* White focus ring */
    }

    /* .modal .modal-header {
        background-color: #4361ee;
        color: white;
        border-radius: 12px 12px 0 0;
        padding: 1rem 1.5rem;
    } */

    /* Alert Modal Styling */
    #alertModal .modal-dialog {
        max-width: 600px;
    }

    #alertModal .modal-content {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    #alertModal .modal-header {
        background-color: #4361ee;
        padding: 1.2rem 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    #alertModal .modal-header .modal-title {
        color: white;
        font-size: 1.25rem;
        font-weight: 600;
    }

    #alertModal .modal-body {
        padding: 1.5rem;
        background-color: #f8fafc;
    }

    /* Form Styling */
    #alertForm .form-label {
        color: #1e293b;
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 0.5rem;
    }

    #alertForm .form-control {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.75rem;
        font-size: 0.95rem;
        color: #1e293b;
        background-color: white;
        transition: all 0.3s ease;
    }

    #alertForm .form-control:focus {
        border-color: #4361ee;
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }

    #alertForm textarea.form-control {
        resize: vertical;
        min-height: 100px;
    }

    /* Performance Summary Box */
    #performanceSummary.alert-info {
        background-color: #eff6ff;
        border: 1px solid #bfdbfe;
        color: #1e40af;
        border-radius: 8px;
        padding: 1rem;
        font-size: 0.95rem;
        margin-bottom: 1.5rem;
    }

    /* Submit Button */
    #alertForm .btn-primary {
        background-color: #4361ee;
        border: none;
        padding: 0.75rem 1.5rem;
        font-size: 0.95rem;
        font-weight: 500;
        border-radius: 8px;
        transition: all 0.3s ease;
        margin-top: 1rem;
    }

    #alertForm .btn-primary:hover {
        background-color: #3151e8;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
    }

    /* Form Group Spacing */
    #alertForm .mb-3 {
        margin-bottom: 1.5rem;
    }

    /* Placeholder Styling */
    #alertForm .form-control::placeholder {
        color: #94a3b8;
        opacity: 0.7;
    }

    /* Focus States */
    #alertForm .form-control:focus::placeholder {
        opacity: 0.5;
    }

    /* Textarea Specific Styling */
    #alertForm textarea.form-control {
        width: 100%;
        resize: vertical;
        min-height: 120px;
        max-height: 300px;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        font-size: 0.95rem;
        line-height: 1.6;
        letter-spacing: 0.01em;
        padding: 1rem;
        color: #1e293b;
        background-color: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        transition: all 0.2s ease;
    }

    /* Specific heights for different textareas */
    #feedbackMessage {
        min-height: 150px;  /* Larger initial height for feedback */
    }

    #recommendedActions {
        min-height: 120px;  /* Slightly smaller for actions */
    }

    /* Textarea Focus State */
    #alertForm textarea.form-control:focus {
        border-color: #4361ee;
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        outline: none;
    }

    /* Textarea Placeholder */
    #alertForm textarea.form-control::placeholder {
        color: #94a3b8;
        font-size: 0.9rem;
        font-style: italic;
        opacity: 0.7;
    }

    /* Scrollbar Styling for Textarea */
    #alertForm textarea.form-control::-webkit-scrollbar {
        width: 8px;
    }

    #alertForm textarea.form-control::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
    }

    #alertForm textarea.form-control::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
    }

    #alertForm textarea.form-control::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    /* Label Styling */
    #alertForm .form-label {
        color: #1e293b;
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 0.75rem;
        display: block;
    }

    /* Form Group Spacing */
    #alertForm .mb-3 {
        margin-bottom: 1.75rem;
    }

    /* Update Marks Modal Styling */
    .marks-modal .modal-content {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .announcement-modal{
        border-radius: 20px;
        background-color: #fbd199;
    }

    .announcement-input{
        border-radius: 10px;
        background-color: white;
    }

    .marks-modal .modal-header {
        background-color: #4361ee;
        padding: 1.2rem 1.5rem;
        border-radius: 12px 12px 0 0;
    }

    .marks-modal .modal-title {
        color: white;
        font-size: 1.25rem;
        font-weight: 600;
    }

    .marks-modal .modal-body {
        padding: 1.5rem;
        background-color: #f8fafc;
    }

    .marks-modal .form-label {
        color: #1e293b;
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 0.75rem;
        display: block;
    }

    .marks-modal .form-control {
        padding: 0.75rem 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1rem;
        color: #1e293b;
        background-color: white;
        transition: all 0.2s ease;
        margin-bottom: 1rem;
    }

    .marks-modal .form-control:focus {
        border-color: #4361ee;
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        outline: none;
    }

    .marks-modal .modal-footer {
        background-color: #f8fafc;
        border-top: 1px solid #e2e8f0;
        border-radius: 10px;
    }

    .marks-modal .btn {
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .marks-modal .btn-primary {
        background-color: #4361ee;
        border: none;
    }

    .marks-modal .btn-primary:hover {
        background-color: #3151e8;
        transform: translateY(-1px);
    }

    .marks-modal .btn-secondary {
        background-color: #e2e8f0;
        border: none;
        color: #475569;
    }

    .marks-modal .btn-secondary:hover {
        background-color: #cbd5e1;
    }

    .marks-modal .mb-3 {
        margin-bottom: 1.5rem;
    } */
    </style>
</head>
<body>
    <div class="container">

        {% include 'navbar.html' %} 

        {% include 'header.html' %} 

        <main>
          <section class="content">
            {% if error %}
            <p>{{ error }}</p>
            {% else %}
                {% for course in courses %}
                <h2 class="section-title">{{ course_code }} : {{course.course_name}}</h2>
                <div class="view-announcement">
                    <button class="accordion btn-show-announcement">Announcements</button>
                    <div class="panel">
                        {% if course.announcements %}
                            {% for announcement_id, announcement in course.announcements.items %}
                                <button class="announcement-title dashboard-accordion" 
                                        onclick="openAnnouncement('{{ announcement.title|escapejs }}', '{{ announcement.content|escapejs }}', '{{ announcement.author|escapejs }}', '{{ announcement.timestamp|escapejs }}')" 
                                        style="display: block; width: 100%; margin: 5px 0;">
                                    {{ announcement.title }}
                                </button>
                            {% endfor %}
                        {% else %}
                            <p>No announcements available.</p>
                        {% endif %}
                    </div>
                </div>

                <form id="updateCourseForm" style="margin-top: 20px;" method="POST" action="{% url 'course-detail' semester_year=course.semester_year course_code=course_code %}" onsubmit="return handleUpdateSubmit(event)">
                    {% csrf_token %}
                    <label>Academic Year: </label>
                    <input id="academic_year" type="text" name="academic_year" placeholder="Enter academic year" maxlength="9" required value="{{ course.academic_year }}" readonly>
                    <br>
                    <label>Semester: </label>
                    {% if request.session.user_role == 'admin'%}
                    <select name="semester" id="semester" required readonly>
                        <option value="" disabled>Select semester</option>
                        <option value="1" {% if semester == "1" %}selected {% else %} disabled {% endif %}>1</option>
                        <option value="2" {% if semester == "2" %}selected {% else %} disabled {% endif %}>2</option>
                    </select>
                    {% else %}
                        <input id="semester" type="text" name="semester" placeholder="Enter semester" maxlength="1" required value="{{ semester }}" readonly>
                    {% endif %}
                    <br>
                    <label>Course Code: </label>
                    <input id="course_code" type="text" name="course_code" placeholder="Enter course code" required value="{{ course_code }}" readonly>
                    <br>
                    <label>Course Name: </label>
                    <input id="course_name" type="text" name="course_name" placeholder="Enter course name" required value="{{ course.course_name }}" {% if request.session.user_role == 'student' or request.session.user_role == 'lecturer' %} readonly {% endif %}>
                    <br>
                    <div id="lecturer-container">
                        <div class="section-header">
                            <h2>Lecturers</h2>
                            {% if request.session.user_role == 'admin'%}
                                <button type="button" onclick="addLecturerField()">+</button>
                            {% endif %}
                        </div>
                        {% for lecturer in course.lecturers %}
                        <label>Lecturer Name {{ forloop.counter }}: </label>
                        <input id="lecturer_name{{ forloop.counter }}" type="text" name="lecturer_name{{ forloop.counter }}" placeholder="Enter lecturer name" required value="{{ lecturer.lecturer_name }}" {% if request.session.user_role == 'student' or request.session.user_role == 'lecturer' %} readonly {% endif %}>
                        <br>
                        <label>Lecturer Email {{ forloop.counter }}: </label>
                        <input id="lecturer_email{{ forloop.counter }}" type="text" name="lecturer_email{{ forloop.counter }}" placeholder="Enter lecturer email" required value="{{ lecturer.lecturer_email }}" {% if request.session.user_role == 'student' or request.session.user_role == 'lecturer' %} readonly {% endif %}>
                        {% endfor %}
                    </div>
                    <div id="venue-time-container">
                        <div class="section-header">
                            <h2>Venue and Time</h2>
                            {% if request.session.user_role == 'admin'%}
                                <button type="button" onclick="addVenueTimeField()">+</button>
                            {% endif %}
                        </div>
                        {% for class in course.venue_time %}
                        <label>Class Venue {{ forloop.counter }}: </label>
                        <input id="class_venue{{ forloop.counter }}" type="text" name="class_venue{{ forloop.counter }}" placeholder="Enter class venue" required value="{{ class.class_venue }}" {% if request.session.user_role == 'student' or request.session.user_role == 'lecturer' %} readonly {% endif %}>
                        <br>
                        <label>Class Day {{ forloop.counter }}: </label>
                        {% if request.session.user_role == 'admin'%}
                        <select name="class_day{{ forloop.counter }}" id="class_day{{ forloop.counter }}" required>
                            <option value="">Select day</option>
                            <option value="Monday" {% if class.class_day == "Monday" %}selected{% endif %}>Monday</option>
                            <option value="Tuesday" {% if class.class_day == "Tuesday" %}selected{% endif %}>Tuesday</option>
                            <option value="Wednesday" {% if class.class_day == "Wednesday" %}selected{% endif %}>Wednesday</option>
                            <option value="Thursday" {% if class.class_day == "Thursday" %}selected{% endif %}>Thursday</option>
                            <option value="Friday" {% if class.class_day == "Friday" %}selected{% endif %}>Friday</option>
                            <option value="Saturday" {% if class.class_day == "Saturday" %}selected{% endif %}>Saturday</option>
                            <option value="Sunday" {% if class.class_day == "Sunday" %}selected{% endif %}>Sunday</option>
                        </select>
                        {% else %}
                            <input id="class_day{{ forloop.counter }}" type="text" name="class_day{{ forloop.counter }}" placeholder="Enter class day" required value="{{ class.class_day }}" readonly>
                        {% endif %}
                        <br>
                        <label>Class Start Time {{ forloop.counter }}: </label>
                        <input id="class_start_time{{ forloop.counter }}" type="time" name="class_start_time{{ forloop.counter }}" value="{{ class.class_start_time }}" required {% if request.session.user_role == 'student' or request.session.user_role == 'lecturer' %} readonly {% endif %}>
                        <br>
                        <label>Class End Time {{ forloop.counter }}: </label>
                        <input id="class_end_time{{ forloop.counter }}" type="time" name="class_end_time{{ forloop.counter }}" value="{{ class.class_end_time }}" required {% if request.session.user_role == 'student' or request.session.user_role == 'lecturer' %} readonly {% endif %}>
                        {% endfor %}
                    </div>
                    {% if request.session.user_role == 'admin'%}
                    <button type="submit" class="btn btn-primary">Update Course</button>
                    {% endif %}
                </form>
                
                {% if request.session.user_role == 'admin' or request.session.user_role == 'student'%}
                    <form id="deleteCourseForm" method="POST" action="{% url 'delete-course' semester_year=course.semester_year course_code=course_code %}">
                        {% csrf_token %}
                        <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                            {% if request.session.user_role == 'admin'%}Delete Course {% else %}Unenroll From Course{% endif %}
                        </button>
                    </form>
                {% endif %}
                {% if request.session.user_role == 'admin' or request.session.user_role == 'lecturer' %}
                    <div class="enrolled-students-section">
                        <h3>Enrolled Students</h3>
                        <div class="export-buttons mb-3">
                            <div class="btn-group" role="group" aria-label="Export Options">
                                <button type="button" class="btn btn-secondary" onclick="exportTable('csv')">
                                    <i class="fas fa-file-csv"></i> Export CSV
                                </button>
                                <button type="button" class="btn btn-success" onclick="exportTable('excel')">
                                    <i class="fas fa-file-excel"></i> Export Excel
                                </button>
                                <button type="button" class="btn btn-danger" onclick="exportTable('pdf')">
                                    <i class="fas fa-file-pdf"></i> Export PDF
                                </button>
                            </div>
                            <div class="upload-button ms-2">
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadMarksModal">
                                    <i class="fas fa-upload"></i> Upload Marks CSV
                                </button>
                            </div>
                            <div class="modal fade" id="uploadMarksModal" tabindex="-1" aria-labelledby="uploadMarksModalLabel" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="uploadMarksModalLabel">Upload Marks CSV</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <form id="uploadMarksForm" method="POST" action="{% url 'upload-marks' semester_year=semester_year course_code=course_code %}" enctype="multipart/form-data">
                                                {% csrf_token %}
                                                <div class="mb-3">
                                                    <label for="csvFile" class="form-label">Choose CSV File</label>
                                                    <input type="file" class="form-control" id="csvFile" name="csvFile" accept=".csv" required>
                                                </div>
                                                <div class="mb-3">
                                                    <small class="text-muted">Note: First row should be headers. Marks should be numbers between 0 and the maximum mark for each coursework.</small>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                    <button type="submit" class="btn btn-primary">Upload</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% if request.session.user_role == 'lecturer' %}
                            <div class="prediction-button ms-2">
                                <button type="button" class="btn btn-warning" onclick="predictStudentRisks()">
                                    <i class="fas fa-chart-line"></i> Predict Student Risks
                                </button>
                            </div>

                            <div class="modal fade" id="predictionResultsModal" tabindex="-1" 
                                 data-bs-backdrop="static" data-bs-keyboard="false">
                                <div class="modal-dialog modal-xl">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Student Risk Predictions</h5>
                                            <button type="button" class="btn-close" 
                                                    onclick="closePredictionModal()" 
                                                    data-bs-dismiss="modal" 
                                                    aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="risk-summary-card">
                                                <h6>Risk Summary</h6>
                                                <div class="risk-stats">
                                                    <div class="stat-item">
                                                        <div class="stat-label">High Risk Students</div>
                                                        <div class="stat-value" id="highRiskCount">0</div>
                                                    </div>
                                                    <div class="stat-item">
                                                        <div class="stat-label">Total Students</div>
                                                        <div class="stat-value" id="totalStudents">0</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="table-responsive">
                                                <table class="table" id="predictionTable">
                                                    <thead>
                                                        <tr>
                                                            <th>Student Name</th>
                                                            <th>Matrix Number</th>
                                                            <th>Current Progress</th>
                                                            <th>Risk Analysis</th>
                                                            <th>Coursework Breakdown</th>
                                                            <th style="width: 120px;">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="predictionTableBody">
                                                        <!-- Predictions will be inserted here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" onclick="closePredictionModal()">Close</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        
                            <!-- Add Alert Modal -->
                            <div class="modal fade" id="alertModal" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Send Alert & Feedback</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <form id="alertForm" onsubmit="return sendAlert(event)">
                                                <input type="hidden" id="alertStudentEmail">
                                                <div class="mb-3">
                                                    <label class="form-label">Student Performance Summary</label>
                                                    <div id="performanceSummary" class="alert alert-info"></div>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="feedbackMessage" class="form-label">Feedback Message</label>
                                                    <textarea 
                                                        class="form-control" 
                                                        id="feedbackMessage" 
                                                        rows="4" 
                                                        required
                                                        placeholder="Enter your feedback message here..."
                                                    ></textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="recommendedActions" class="form-label">Recommended Actions</label>
                                                    <textarea 
                                                        class="form-control" 
                                                        id="recommendedActions" 
                                                        rows="3" 
                                                        required
                                                        placeholder="Enter recommended actions here..."
                                                    ></textarea>
                                                </div>
                                                <button type="submit" class="btn btn-primary w-100">
                                                    Send Alert
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        <div class="search-bar mb-3">
                            <input 
                                type="text" 
                                id="studentSearch" 
                                class="form-control" 
                                placeholder="Search students by name, matrix number, or email"
                                onkeyup="searchTable()"
                            >
                        </div>
                        <table class="table" id="marksTable">
                            <thead>
                                <tr>
                                    <th data-column="0" data-type="number" style="cursor: pointer;">
                                        No. <span class="sort-icon"></span>
                                    </th>
                                    <th data-column="1" data-type="text" style="cursor: pointer;">
                                        Name <span class="sort-icon"></span>
                                    </th>
                                    <th data-column="2" data-type="text" style="cursor: pointer;">
                                        Matrix Number <span class="sort-icon"></span>
                                    </th>
                                    <th data-column="3" data-type="text" style="cursor: pointer;">
                                        Email <span class="sort-icon"></span>
                                    </th>
                                    {% for coursework in course.courseworks %}
                                        <th data-column="{{ forloop.counter|add:3 }}" data-type="number" style="cursor: pointer;">
                                            {{ coursework.type }} ({{ coursework.total_mark }}%) <span class="sort-icon"></span>
                                        </th>
                                    {% endfor %}
                                    <th data-column="{{ course.courseworks|length|add:4 }}" data-type="number" style="cursor: pointer;">
                                        Total Coursework Mark ({{ total_marks }}%) <span class="sort-icon"></span>
                                    </th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if enrolled_students %}
                                    {% for student in enrolled_students %}
                                        <tr>
                                            <td style="text-align: center;">{{ forloop.counter }}</td>
                                            <td>{{ student.name }}</td>
                                            <td style="text-align: center;">{{ student.matrix }}</td>
                                            <td>{{ student.email }}</td>

                                            {% for coursework in course.courseworks %}
                                                <td style="text-align: center;">
                                                    {% if coursework.type in student.marks %}
                                                        {{ student.marks|get_item:coursework.type }}
                                                    {% else %}
                                                        0.0
                                                    {% endif %}
                                                </td>
                                            {% endfor %}
                                            <td style="text-align: center;">{{ student.total_mark|default:0.0 }}</td>
                                            <td>
                                                <div class="action-buttons-group">
                                                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#marksModal{{ student.email|slugify }}">
                                                        Edit Marks
                                                    </button>
                                                    {% if request.session.user_role == 'admin' %}
                                                        <button type="button" class="btn btn-danger" 
                                                            onclick="confirmUnenroll('{{ student.email }}', '{{ course_code }}', '{{ course.academic_year }}', '{{ semester }}')">
                                                            Unenroll
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>

                                        <!-- Marks Modal for each student -->
                                        <div class="modal fade marks-modal" id="marksModal{{ student.email|slugify }}" tabindex="-1" aria-labelledby="marksModalLabel{{ student.email|slugify }}" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="marksModalLabel{{ student.email|slugify }}">
                                                            Update Marks for {{ student.name }}
                                                        </h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <form method="POST" action="{% url 'update-marks' semester_year=semester_year course_code=course_code student_email=student.email %}" 
                                                              onsubmit="return handleMarksUpdate(event, this)">
                                                            {% csrf_token %}
                                                            {% for coursework in course.courseworks %}
                                                                <div class="mb-3">
                                                                    <label for="mark_{{ coursework.type|slugify }}" class="form-label">
                                                                        {{ coursework.type }} (Max: {{ coursework.total_mark }}%)
                                                                    </label>
                                                                    <input type="number" 
                                                                           class="form-control" 
                                                                           id="mark_{{ coursework.type|slugify }}"
                                                                           name="mark_{{ coursework.type|slugify }}"
                                                                           min="0" 
                                                                           max="{{ coursework.total_mark }}"
                                                                           step="0.01"
                                                                           value="{% for key, value in student.marks.items %}{% if key == coursework.type %}{{ value }}{% endif %}{% endfor %}">
                                                                </div>
                                                            {% endfor %}
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                                <button type="submit" class="btn btn-primary">Save Changes</button>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="{{ 5|add:course.courseworks|length }}" class="text-center">No students enrolled in this course</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                {% elif request.session.user_role == 'student' %}
                    <div class="enrolled-students-section">
                        <h3>Your Coursework Marks</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    {% for coursework in course.courseworks %}
                                        <th>{{ coursework.type }} ({{ coursework.total_mark }}%)</th>
                                    {% endfor %}
                                    <th>Total Coursework Mark ({{ total_marks }}%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in enrolled_students %}
                                    {% if student.email == request.session.user_email %}
                                        <tr>
                                            {% for coursework in course.courseworks %}
                                                <td style="text-align: center;">
                                                    {% if coursework.type in student.marks %}
                                                        {{ student.marks|get_item:coursework.type }}
                                                    {% else %}
                                                        0
                                                    {% endif %}
                                                </td>
                                            {% endfor %}
                                            <td style="text-align: center;">{{ student.total_mark|default:0 }}</td>
                                        </tr>
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
                {% endfor %}
            {% endif %}
        </section>
        </main>

        {% include 'footer.html' %} 
    </div>

    <script src="{% static 'js/backend.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script>
    // Initialize variables from Django template context
    const semester_year = "{{ semester_year|escapejs }}";
    const course_code = "{{ course_code|escapejs }}";
    const csrfToken = "{{ csrf_token }}";

    // Debug log to verify variables are set
    console.log('Template variables:', { semester_year, course_code });

    function confirmDelete() {
        Swal.fire({
            title: 'Are you sure?',
            text: "{% if request.session.user_role == 'admin' %}This will delete the course for all students!{% else %}You will be unenrolled from this course!{% endif %}",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                submitDeleteForm();
            }
        });
    }

    async function submitDeleteForm() {
        try {
            const form = document.getElementById('deleteCourseForm');
            const formData = new FormData(form);
            
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                await Swal.fire({
                    icon: 'success',
                    title: 'Deleted!',
                    text: data.message,
                    timer: 2000,
                    showConfirmButton: false
                });
                window.location.href = "{% url 'academic' %}";
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'An error occurred while deleting the course.'
                });
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred while processing your request.'
            });
        }
    }

    async function handleUpdateSubmit(event) {
        event.preventDefault();
        
        try {
            const form = document.getElementById('updateCourseForm');
            const formData = new FormData(form);
            
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'Accept': 'application/json'
                }
            });
            
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                const data = await response.json();
                
                if (data.status === 'success') {
                    await Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: data.message,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    window.location.reload();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message || 'An error occurred while updating the course.'
                    });
                }
            } else {
                const text = await response.text();
                console.error('Non-JSON response:', text);
                throw new Error('Server returned non-JSON response');
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred while processing your request.'
            });
        }
        return false;
    }

    function exportTable(format) {
        const table = document.getElementById('marksTable');
        const courseCode = '{{ course_code }}';
        const fileName = `${courseCode}_marks`;

        // Get headers (exclude last column - Actions)
        const headers = Array.from(table.querySelectorAll('thead th'))
            .slice(0, -1)  // Remove last header
            .map(th => th.textContent.trim());
        
        // Get data (exclude last column - Actions)
        const rows = Array.from(table.querySelectorAll('tbody tr')).map(row => 
            Array.from(row.querySelectorAll('td'))
                .slice(0, -1)  // Remove last cell
                .map(cell => cell.textContent.trim())
        );

        switch(format) {
            case 'csv':
                exportCSV(headers, rows, fileName);
                break;
            case 'excel':
                exportExcel(headers, rows, fileName);
                break;
            case 'pdf':
                exportPDF(headers, rows, fileName);
                break;
        }
    }

    function exportCSV(headers, rows, fileName) {
        const csvContent = [
            headers.join(','),
            ...rows.map(row => row.join(','))
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${fileName}.csv`;
        link.click();
    }

    function exportExcel(headers, rows, fileName) {
        const worksheet = XLSX.utils.aoa_to_sheet([headers, ...rows]);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Marks');
        XLSX.writeFile(workbook, `${fileName}.xlsx`);
    }

    function exportPDF(headers, rows, fileName) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.autoTable({
            head: [headers],
            body: rows,
            theme: 'grid',
            styles: { fontSize: 8 },
            headStyles: { fillColor: [66, 139, 202] }
        });

        doc.save(`${fileName}.pdf`);
    }

    function confirmUnenroll(studentEmail, courseCode, academicYear, semester) {
        Swal.fire({
            title: 'Are you sure?',
            text: "This will unenroll the student from this course!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, unenroll!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                unenrollStudent(studentEmail, courseCode, academicYear, semester);
            }
        });
    }

    async function unenrollStudent(studentEmail, courseCode, academicYear, semester) {
        try {
            const response = await fetch('/unenroll-student/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    student_email: studentEmail,
                    course_code: courseCode,
                    academic_year: academicYear,
                    semester: semester
                })
            });

            const data = await response.json();
            
            if (data.status === 'success') {
                await Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: 'Student has been unenrolled from the course.',
                    timer: 2000,
                    showConfirmButton: false
                });
                window.location.reload();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'An error occurred while unenrolling the student.'
                });
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred while processing your request.'
            });
        }
    }

    function searchTable() {
        const searchInput = document.getElementById('studentSearch');
        const filter = searchInput.value.toLowerCase();
        const table = document.getElementById('marksTable');
        const rows = table.getElementsByTagName('tr');

        // Loop through all table rows (skip header)
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const cells = row.getElementsByTagName('td');
            if (cells.length === 0) continue; // Skip if no cells (like in empty message row)

            // Check name (cell 1), matrix (cell 2), and email (cell 3)
            const name = cells[1].textContent || cells[1].innerText;
            const matrix = cells[2].textContent || cells[2].innerText;
            const email = cells[3].textContent || cells[3].innerText;
            
            const matchFound = 
                name.toLowerCase().includes(filter) ||
                matrix.toLowerCase().includes(filter) ||
                email.toLowerCase().includes(filter);

            row.style.display = matchFound ? '' : 'none';
        }
    }

    let lastSortedColumn = -1;
    let isAscending = true;

    function sortTable(columnIndex, type) {
        const table = document.getElementById('marksTable');
        const tbody = table.getElementsByTagName('tbody')[0];
        const rows = Array.from(tbody.getElementsByTagName('tr'));
        const headers = table.getElementsByTagName('th');

        // Reset all headers except Actions
        for (let i = 0; i < headers.length - 1; i++) {
            headers[i].classList.remove('asc', 'desc');
        }

        // Determine sort direction
        if (lastSortedColumn === columnIndex) {
            isAscending = !isAscending;
        } else {
            isAscending = false;
        }
        lastSortedColumn = columnIndex;

        // Add sort indicator
        headers[columnIndex].classList.add(isAscending ? 'asc' : 'desc');

        // Sort rows
        rows.sort((a, b) => {
            let aValue = a.cells[columnIndex].textContent.trim();
            let bValue = b.cells[columnIndex].textContent.trim();

            if (type === 'number') {
                // Convert to numbers and handle empty/non-numeric values
                aValue = parseFloat(aValue) || 0;
                bValue = parseFloat(bValue) || 0;
                return isAscending ? aValue - bValue : bValue - aValue;
            } else {
                // Text comparison
                return isAscending 
                    ? aValue.localeCompare(bValue)
                    : bValue.localeCompare(aValue);
            }
        });

        // Reorder rows in the table
        rows.forEach(row => tbody.appendChild(row));

        // Update row numbers based on sort direction
        rows.forEach((row, index) => {
            row.cells[0].textContent = isAscending ? index + 1 : rows.length - index;
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const table = document.getElementById('marksTable');
        const headers = table.getElementsByTagName('th');
        
        for (let header of headers) {
            if (header.dataset.column) {
                header.addEventListener('click', function() {
                    sortTable(parseInt(this.dataset.column), this.dataset.type);
                });
            }
        }
    });

    document.getElementById('uploadMarksForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show loading alert
        Swal.fire({
            title: 'Processing CSV File',
            html: 'Please wait while we process the student marks...',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // Submit the form
        const formData = new FormData(this);
        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            // Close loading alert and show result
            Swal.fire({
                icon: data.status === 'success' ? 'success' : 'error',
                title: data.status === 'success' ? 'Success!' : 'Error!',
                text: data.message,
                timer: data.status === 'success' ? 2000 : undefined,
                showConfirmButton: data.status !== 'success'
            }).then(() => {
                if (data.status === 'success') {
                    window.location.reload();
                }
            });
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred while processing the file.'
            });
        });
    });

    async function predictStudentRisks() {
        try {
            // Show loading alert
            Swal.fire({
                title: 'Analyzing Student Data',
                html: 'Generating risk predictions...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Make the prediction request
            const response = await fetch(`/predict-risks/${course_code}/${semester_year}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            });

            const data = await response.json();

            // Close loading alert
            Swal.close();

            if (data.status === 'success') {
                displayPredictions(data.predictions);
                const modal = new bootstrap.Modal(document.getElementById('predictionResultsModal'));
                modal.show();
            } else {
                throw new Error(data.message || 'Failed to predict risks');
            }
        } catch (error) {
            // Close loading alert if there's an error
            Swal.close();
            
            console.error('Error predicting risks:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message || 'Failed to predict student risks'
            });
        }
    }

    function displayPredictions(predictions) {
        if (!predictions || predictions.length === 0) {
            Swal.fire({
                icon: 'info',
                title: 'No Data',
                text: 'No student data available for predictions'
            });
            return;
        }

        const tbody = document.getElementById('predictionTableBody');
        if (!tbody) {
            console.error('Prediction table body element not found');
            return;
        }

        tbody.innerHTML = '';
        let highRiskCount = 0;

        predictions.forEach(pred => {
            if (!pred) return;
            
            try {
                if (pred.risk_level === 'High Risk') highRiskCount++;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${pred.student_name || 'N/A'}</td>
                    <td>${pred.matrix_number || 'N/A'}</td>
                    <td>
                        <div class="progress">
                            <div class="progress-bar ${getProgressBarClass(pred.current_progress || 0)}" 
                                 role="progressbar" 
                                 style="width: ${pred.current_progress || 0}%">
                                ${(pred.current_progress || 0).toFixed(1)}%
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge ${getRiskBadgeClass(pred.risk_level || 'Unknown')}">
                            ${pred.risk_level || 'Unknown'}
                        </span>
                        <br>
                        <small>Confidence: ${(pred.prediction_confidence || 0).toFixed(1)}%</small>
                    </td>
                    <td class="coursework-breakdown">
                        ${generateCourseworkBreakdown(pred.coursework_breakdown)}
                    </td>
                    <td>
                        <button class="btn btn-warning btn-sm alert-btn" 
                                onclick='showAlert(${JSON.stringify(pred).replace(/'/g, "&#39;")})'>
                            <i class="fas fa-bell"></i> Alert & Feedback
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            } catch (error) {
                console.error('Error processing prediction:', error, pred);
            }
        });

        // Update counters
        const highRiskElement = document.getElementById('highRiskCount');
        const totalElement = document.getElementById('totalStudents');
        
        if (highRiskElement) highRiskElement.textContent = highRiskCount;
        if (totalElement) totalElement.textContent = predictions.length;

        // Show modal with proper backdrop handling
        const modal = document.getElementById('predictionResultsModal');
        if (modal) {
            const bsModal = new bootstrap.Modal(modal, {
                backdrop: 'static',  // Prevents closing when clicking outside
                keyboard: true       // Allows closing with Esc key
            });
            
            // Clean up when modal is hidden
            modal.addEventListener('hidden.bs.modal', function () {
                document.body.classList.remove('modal-open');
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
            });

            bsModal.show();
        }
    }

    function generateCourseworkBreakdown(breakdown) {
        console.log('Received breakdown:', breakdown); // Debug log

        if (!breakdown || Object.keys(breakdown).length === 0) {
            return '<small>No coursework data available</small>';
        }

        return Object.entries(breakdown).map(([type, data]) => {
            const achieved = data.achieved || 0;
            const total = data.total || 0;
            const percentage = data.percentage || 0;

            return `
                <div class="coursework-item mb-2">
                    <div class="d-flex justify-content-between">
                        <small>${type}</small>
                        <small>${achieved}/${total} (${percentage.toFixed(1)}%)</small>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar ${getProgressBarClass(percentage)}" 
                             role="progressbar" 
                             style="width: ${percentage}%">
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function getProgressBarClass(percentage) {
        if (percentage >= 70) return 'bg-success';
        if (percentage >= 40) return 'bg-warning';
        return 'bg-danger';
    }

    function getRiskBadgeClass(risk) {
        switch(risk) {
            case 'Low Risk': return 'bg-success';
            case 'Medium Risk': return 'bg-warning';
            case 'High Risk': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }

    let currentPredictionData = null;

    function showAlert(predictionData) {
        try {
            console.log('Showing alert for:', predictionData);
            
            // Store the prediction data globally
            currentPredictionData = predictionData;
            
            if (!predictionData || !predictionData.student_email) {
                throw new Error('Invalid student data');
            }

            // Set student email in hidden input
            document.getElementById('alertStudentEmail').value = predictionData.student_email;
            
            // Set performance summary
            const summaryHTML = `
                <strong>Student: ${predictionData.student_name || 'N/A'}</strong><br>
                Matrix Number: ${predictionData.matrix_number || 'N/A'}<br>
                Current Progress: ${(predictionData.current_progress || 0).toFixed(1)}%<br>
                Risk Level: <span class="badge ${getRiskBadgeClass(predictionData.risk_level)}">${predictionData.risk_level || 'Unknown'}</span>
                <hr>
                <strong>Coursework Breakdown:</strong><br>
                ${Object.entries(predictionData.coursework_breakdown || {})
                    .map(([type, data]) => 
                        `${type}: ${data.achieved || 0}/${data.total || 0} (${(data.percentage || 0).toFixed(1)}%)`
                    ).join('<br>')}
            `;
            
            const summaryElement = document.getElementById('performanceSummary');
            if (summaryElement) {
                summaryElement.innerHTML = summaryHTML;
            }
            
            // Set default feedback and actions
            const feedbackElement = document.getElementById('feedbackMessage');
            const actionsElement = document.getElementById('recommendedActions');
            
            if (feedbackElement) {
                feedbackElement.value = getDefaultFeedback(predictionData);
            }
            if (actionsElement) {
                actionsElement.value = getDefaultActions(predictionData);
            }
            
            // Show modal
            const modal = document.getElementById('alertModal');
            if (modal) {
                new bootstrap.Modal(modal).show();
            } else {
                throw new Error('Alert modal not found');
            }
        } catch (error) {
            console.error('Error showing alert:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to show alert dialog: ' + error.message
            });
        }
    }

    async function sendAlert(event) {
        event.preventDefault();
        
        try {
            if (!currentPredictionData) {
                throw new Error('No prediction data available');
            }

            const studentEmail = document.getElementById('alertStudentEmail').value;
            const feedbackMessage = document.getElementById('feedbackMessage').value;
            const recommendedActions = document.getElementById('recommendedActions').value;

            console.log('Sending alert with:', { 
                studentEmail, 
                course_code, 
                semester_year,
                currentPredictionData 
            });

            const response = await fetch('/send-student-alert/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    student_email: studentEmail,
                    feedback: feedbackMessage,
                    actions: recommendedActions,
                    course_code: course_code,
                    semester_year: semester_year,
                    risk_level: currentPredictionData.risk_level,
                    current_progress: currentPredictionData.current_progress
                })
            });

            const data = await response.json();
            
            if (data.status === 'success') {
                // Close the modal
                const modal = document.getElementById('alertModal');
                const modalInstance = bootstrap.Modal.getInstance(modal);
                modalInstance.hide();

                // Reset the current prediction data
                currentPredictionData = null;

                // Show success message
                await Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: 'Alert and feedback sent successfully',
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                throw new Error(data.message || 'Failed to send alert');
            }
        } catch (error) {
            console.error('Error sending alert:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message || 'Failed to send alert and feedback'
            });
        }
        return false;
    }

    function getDefaultFeedback(predictionData) {
        const progress = (predictionData.current_progress || 0).toFixed(1);
        
        if (predictionData.risk_level === 'High Risk') {
            return `I am concerned about your current academic progress in this course. Your overall coursework achievement is at ${progress}%, which puts you at risk of not meeting the course requirements. Let's discuss how we can improve your performance.`;
        } else if (predictionData.risk_level === 'Medium Risk') {
            return `While you are making progress in the course with ${progress}% achievement, there's room for improvement. I'd like to help ensure you reach your full potential in this course.`;
        }
        return `You are performing well in this course with ${progress}% achievement. Keep up the good work! Let me know if you need any additional support.`;
    }

    function getDefaultActions(predictionData) {
        if (predictionData.risk_level === 'High Risk') {
            return "1. Schedule an urgent consultation session\n2. Complete all pending coursework\n3. Attend all remaining classes\n4. Consider forming a study group\n5. Review difficult topics with lecturer";
        } else if (predictionData.risk_level === 'Medium Risk') {
            return "1. Review challenging topics\n2. Submit all coursework on time\n3. Participate actively in class\n4. Consider additional practice exercises";
        }
        return "1. Continue your current study approach\n2. Consider helping peers who need assistance\n3. Prepare early for upcoming assessments\n4. Maintain regular attendance";
    }

    // Add this function to properly close the modal
    function closePredictionModal() {
        const modal = document.getElementById('predictionResultsModal');
        if (modal) {
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) {
                bsModal.hide();
            }
            // Clean up manually just in case
            document.body.classList.remove('modal-open');
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.remove();
            }
        }
    }

    // Function to open the announcement modal and display details
    function openAnnouncement(title, content, author, timestamp) {
        // Set the modal content
        document.getElementById('ann-title').value = title; // Assuming you have an input for the title
        document.getElementById('ann-content').value = content; // Assuming you have a textarea for the content
        document.getElementById('form-author').innerText = author; // Assuming you have a span or div for the author
        document.getElementById('form-timestamp').innerText = timestamp; // Assuming you have a span or div for the timestamp

        // Show the modal using Bootstrap's modal method
        const modal = new bootstrap.Modal(document.getElementById('viewAnnouncement'));
        modal.show();
    }

    // Add this new function to handle marks update
    async function handleMarksUpdate(event, form) {
        event.preventDefault();
        
        try {
            const formData = new FormData(form);
            
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'Accept': 'application/json'  // Request JSON response
                }
            });
            
            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                const data = await response.json();
                
                if (data.status === 'success') {
                    // Close the modal
                    const modal = bootstrap.Modal.getInstance(form.closest('.modal'));
                    modal.hide();

                    // Show success message
                    await Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Marks updated successfully',
                        timer: 2000,
                        showConfirmButton: false
                    });

                    // Reload the page to show updated marks
                    window.location.reload();
                } else {
                    throw new Error(data.message || 'Failed to update marks');
                }
            } else {
                // Handle non-JSON response
                const text = await response.text();
                console.error('Non-JSON response:', text);
                throw new Error('Server returned non-JSON response');
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message || 'An error occurred while updating marks'
            });
        }
        
        return false;
    }

    // Add event listener to handle modal hidden event
    document.getElementById('predictionResultsModal').addEventListener('hidden.bs.modal', function () {
        document.body.style.removeProperty('overflow');
        document.body.style.removeProperty('padding-right');
        document.body.classList.remove('modal-open');
    });
    </script>

    <div class="modal fade" id="viewAnnouncement" tabindex="-1" aria-labelledby="updateAnnouncementModalLabel" aria-hidden="true">
        <div class="modal-xl modal-dialog">
            <div class="modal-content announcement-modal">
                <div class="modal-header">
                    <h2 class="modal-title">Announcement Details</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="onlyViewAnnouncement" class="container-fluid">
                        {% csrf_token %}
                        <div class="form-group" style="background-color: white; padding: 10px; border: 2px solid black; border-radius: 5px;">
                            <label for="form-author" style="display: inline; margin-right: 5px;">Author:</label>
                            <p id="form-author" style="display: inline; margin: 0;"></p>
                        </div>
                        <div class="form-group">
                            <label for="ann-title">Title:</label>
                            <input type="text" class="select-width form-select form-control announcement-input" id="ann-title" disabled>
                        </div>
                        <div class="form-group">
                            <label for="ann-content">Content:</label>
                            <textarea class="form-control announcement-input" id="ann-content" rows="10" disabled></textarea>
                        </div>
                        <div class="form-group">
                            <label for="form-timestamp">Post Time:</label>
                            <p id="form-timestamp"></p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
